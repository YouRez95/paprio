generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  imageUrl  String?
  firstName String?
  lastName  String?
  clerkId   String   @unique
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Projects owned by this user
  ownedProjects Project[] @relation("ProjectOwner")

  // Projects this user is a member of (including as owner)
  projectMemberships ProjectMember[]

  // User-specific settings for projects
  projectSettings UserProjectSettings[]

  // Tags created by this user
  tags            Tag[]
  DocumentVersion DocumentVersion[]
}

model Project {
  id          String    @id @default(uuid())
  name        String
  description String?
  deletedAt   DateTime?
  ownerId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  owner        User                  @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members      ProjectMember[]
  folders      Folder[]
  documents    Document[]
  userSettings UserProjectSettings[]
  tags         ProjectTag[]

  // @@index([deletedAt, createdAt])
  // @@index([ownerId])
}

model ProjectMember {
  id        String      @id @default(uuid())
  projectId String
  userId    String
  role      ProjectRole @default(VIEWER)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  // @@index([userId])
  // @@index([projectId, role])

  // A user can only be a member of a project once
  @@unique([projectId, userId])
}

model UserProjectSettings {
  id         String   @id @default(uuid())
  userId     String
  projectId  String
  isArchived Boolean  @default(false)
  isFavorite Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  // @@index([userId, isArchived])
  // @@index([userId, isFavorite])

  // Each user can have only one settings record per project
  @@unique([userId, projectId])
}

model Folder {
  id             String    @id @default(uuid())
  name           String
  projectId      String
  parentFolderId String?
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentFolder Folder?    @relation("SubFolders", fields: [parentFolderId], references: [id], onDelete: Restrict)
  subFolders   Folder[]   @relation("SubFolders")
  documents    Document[]
  // @@index([projectId])
  // @@index([parentFolderId])

  @@unique([projectId, name, parentFolderId, deletedAt])
}

model Document {
  id                String            @id @default(uuid())
  title             String
  projectId         String
  folderId          String?
  latexConfig       Json? // page size, margins, etc.
  latexSource       String? // final LaTeX code snapshot
  latestVersion     Int               @default(0)
  pdfR2Key          String?
  lastCompiledAt    DateTime?
  compilationStatus CompilationStatus @default(PENDING)
  compilationError  String?
  deletedAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  project  Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folder   Folder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  blocks   DocumentBlock[]
  versions DocumentVersion[]
  // @@index([projectId])
  // @@index([folderId])
  // @@index([deletedAt])

  @@unique([projectId, title, folderId, deletedAt])
}

model DocumentVersion {
  id          String   @id @default(uuid())
  documentId  String
  title       String
  latexConfig Json
  latexSource String
  version     Int
  createdBy   String?
  pdfR2Key    String?
  createdAt   DateTime @default(now())
  hash        String
  note        String?
  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([documentId, version])
}

model DocumentBlock {
  id          String   @id @default(uuid())
  documentId  String
  blockDefId  String
  order       Int
  name        String
  config      Json // User's specific config: colors, dimensions, content, etc.
  latexSource String? // cached compiled LaTeX for this block
  packages    Json? // cached required packages for this block
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  document        Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  blockDefinition BlockDefinition @relation(fields: [blockDefId], references: [id])

  // @@index([documentId, order])
}

model BlockDefinition {
  id            String        @id @default(uuid())
  name          String
  description   String?
  category      BlockCategory
  type          BlockType
  thumbnailUrl  String?
  // LaTeX template with placeholders
  latexTemplate String        @db.Text //ex: "\\begin{tcolorbox}[colback={{colback}}, ...]"

  // Define configurable properties
  variableRules    Json // Rules for dynamic variables based on config
  configSchema     Json // JSON Schema defining all configurable properties
  defaultConfig    Json // Default values for all properties
  requiredPackages Json // Array of required packages // "requiredPackages": [{ "name": "tcolorbox", "options": ["most"] },{ "name": "xcolor", "options": [] }]

  // Usage tracking
  usageCount     Int             @default(0) // Track popularity
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  documentBlocks DocumentBlock[]
}

model Tag {
  id        String   @id @default(uuid())
  userId    String
  text      String
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects ProjectTag[]
  // @@index([userId])

  @@unique([text, userId])
}

model ProjectTag {
  projectId String
  tagId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([projectId, tagId])
}

enum Plan {
  FREE
  PRO
}

enum ProjectRole {
  VIEWER // Can only view
  EDITOR // Can view and edit
  ADMIN // Can view, edit, and manage members
}

enum CompilationStatus {
  SUCCESS
  ERROR
  PENDING
  FAILED
}

enum BlockCategory {
  TCOLORBOX
  SHADOWBOX
}

enum BlockType {
  BOX
  TABLE
  FIGURE
  TEXT
  ALL
}
